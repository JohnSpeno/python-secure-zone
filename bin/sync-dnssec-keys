#!/bin/sh
#
# sync dnskeys from primary asgs server to secondary
# 
# This is safe to run on both sides at once. only runs if is_asgs returns 0
#

quit () 
{
    echo "This machine isn't primary. No sync will be done."
    exit 1
}

# only run on primary. otherwise quit
is_asgs || quit 

HOST=`hostname`

if [ $HOST = 'assailants1.net.isc.upenn.edu' ] ; then
    REMOTE_HOST='assailants2.net.isc.upenn.edu'
elif [ $HOST = 'assailants2.net.isc.upenn.edu' ] ; then
    REMOTE_HOST='assailants1.net.isc.upenn.edu'
else
    exit 1
fi

ZONE_DIR=/usr/local/etc/bind/zones

# this copies new keys (and keys in new places) to secondary
cd "$ZONE_DIR"
find . -name 'K*.key' -or -name 'K*.private' | \
rsync -a --files-from=- -e 'ssh' \
"$ZONE_DIR" "${REMOTE_HOST}:${ZONE_DIR}"/

# xxx need to remove keys on secondary that don't exist on primary
